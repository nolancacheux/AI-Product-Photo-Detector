name: Request Vertex AI Quota

on:
  workflow_dispatch:

jobs:
  request-quota:
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install alpha components
        run: gcloud components install alpha --quiet

      - name: Check current Vertex AI quotas
        run: |
          echo "=== Enabled Vertex AI API ==="
          gcloud services list --enabled --filter="name:aiplatform" --project=ai-product-detector-487013

          echo ""
          echo "=== Listing all Vertex AI consumer quota overrides ==="
          gcloud alpha services quota list \
            --service=aiplatform.googleapis.com \
            --consumer=projects/ai-product-detector-487013 2>&1 | head -60 || true

          echo ""
          echo "=== Specific training quotas ==="
          gcloud alpha services quota list \
            --service=aiplatform.googleapis.com \
            --consumer=projects/ai-product-detector-487013 \
            --filter="metric:custom_model_training" 2>&1 || true

      - name: Request CPU quota increase
        run: |
          gcloud alpha services quota update \
            --service=aiplatform.googleapis.com \
            --consumer=projects/ai-product-detector-487013 \
            --metric=aiplatform.googleapis.com/custom_model_training_cpus \
            --unit="1/{project}/{region}" \
            --dimensions=region=us-central1 \
            --value=8 \
            --force --quiet 2>&1 || echo "CPU quota request failed - may need manual approval"

      - name: Request T4 GPU quota increase
        run: |
          gcloud alpha services quota update \
            --service=aiplatform.googleapis.com \
            --consumer=projects/ai-product-detector-487013 \
            --metric=aiplatform.googleapis.com/custom_model_training_nvidia_t4_gpus \
            --unit="1/{project}/{region}" \
            --dimensions=region=us-central1 \
            --value=1 \
            --force --quiet 2>&1 || echo "GPU quota request failed - may need manual approval"

      - name: Try europe-west1 too
        run: |
          gcloud alpha services quota update \
            --service=aiplatform.googleapis.com \
            --consumer=projects/ai-product-detector-487013 \
            --metric=aiplatform.googleapis.com/custom_model_training_cpus \
            --unit="1/{project}/{region}" \
            --dimensions=region=europe-west1 \
            --value=8 \
            --force --quiet 2>&1 || echo "CPU quota (eu) request failed"
          
          gcloud alpha services quota update \
            --service=aiplatform.googleapis.com \
            --consumer=projects/ai-product-detector-487013 \
            --metric=aiplatform.googleapis.com/custom_model_training_nvidia_t4_gpus \
            --unit="1/{project}/{region}" \
            --dimensions=region=europe-west1 \
            --value=1 \
            --force --quiet 2>&1 || echo "GPU quota (eu) request failed"
