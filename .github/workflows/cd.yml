# ==============================================================================
# CD â€” Build, Push & Deploy to Cloud Run
# Triggered on push to main (only after CI passes).
# Before building, syncs the latest trained model from GCS if available.
# Requires secrets: GCP_PROJECT_ID, GCP_SA_KEY, GCS_BUCKET, API_KEY
# ==============================================================================

name: CD

on:
  push:
    branches: [main]

  # Allow manual deploy / rollback with custom image tag
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (commit SHA or 'latest' to build fresh)"
        required: false
        default: "latest"
      memory:
        description: "Cloud Run memory allocation"
        required: false
        default: "1Gi"
        type: choice
        options:
          - 512Mi
          - 1Gi
          - 2Gi

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

env:
  REGION: europe-west1
  SERVICE: ai-product-detector
  REGISTRY: europe-west1-docker.pkg.dev
  IMAGE: europe-west1-docker.pkg.dev/ai-product-detector-487013/ai-product-detector/api

jobs:
  # --------------------------------------------------------------------------
  # Wait for CI to pass (on push events)
  # --------------------------------------------------------------------------
  ci-check:
    name: Wait for CI
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Wait for CI workflow
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          running-workflow-name: "Wait for CI"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          check-regexp: "^(Lint|Tests|Type Checking)"
          wait-interval: 15
          allowed-conclusions: success

  # --------------------------------------------------------------------------
  # Build & Push Docker Image
  # --------------------------------------------------------------------------
  build:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [ci-check]
    if: always() && (needs.ci-check.result == 'success' || github.event_name == 'workflow_dispatch')

    permissions:
      contents: read
      id-token: write

    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      # Sync latest trained model from GCS (Vertex AI output) if newer than repo copy
      - name: Sync latest model from GCS
        run: |
          GCS_MODEL="gs://${{ secrets.GCS_BUCKET }}/models/best_model.pt"
          LOCAL_MODEL="models/checkpoints/best_model.pt"
          mkdir -p models/checkpoints

          # Check if a model exists in GCS
          if gsutil ls "${GCS_MODEL}" > /dev/null 2>&1; then
            GCS_UPDATED=$(gsutil stat "${GCS_MODEL}" | grep "Update time" | sed 's/.*Update time: *//')
            echo "GCS model last updated: ${GCS_UPDATED}"

            if [ -f "${LOCAL_MODEL}" ]; then
              LOCAL_SIZE=$(stat -c%s "${LOCAL_MODEL}")
              GCS_SIZE=$(gsutil stat "${GCS_MODEL}" | grep "Content-Length" | awk '{print $2}')
              echo "Local model size: ${LOCAL_SIZE}, GCS model size: ${GCS_SIZE}"

              # Download if sizes differ (indicates a newer model)
              if [ "${LOCAL_SIZE}" != "${GCS_SIZE}" ]; then
                echo "GCS model differs from local copy. Downloading..."
                gsutil cp "${GCS_MODEL}" "${LOCAL_MODEL}"
                echo "Downloaded latest model from GCS."
              else
                echo "Local model matches GCS. No download needed."
              fi
            else
              echo "No local model found. Downloading from GCS..."
              gsutil cp "${GCS_MODEL}" "${LOCAL_MODEL}"
              echo "Downloaded model from GCS."
            fi
          else
            echo "No model found in GCS bucket. Using repo model."
          fi

          # Verify a model exists for the build
          if [ -f "${LOCAL_MODEL}" ]; then
            echo "Model ready: $(ls -lh ${LOCAL_MODEL})"
          else
            echo "WARNING: No model file found. Build may use a stale or missing model."
          fi

      - name: Determine image tag
        id: tag
        run: |
          if [ "${{ github.event.inputs.image_tag }}" != "" ] && [ "${{ github.event.inputs.image_tag }}" != "latest" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> "$GITHUB_OUTPUT"
            echo "skip_build=true" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ github.sha }}" >> "$GITHUB_OUTPUT"
            echo "skip_build=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Docker Buildx
        if: steps.tag.outputs.skip_build == 'false'
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        if: steps.tag.outputs.skip_build == 'false'
        run: |
          docker build -f docker/Dockerfile \
            -t ${{ env.IMAGE }}:${{ steps.tag.outputs.tag }} \
            -t ${{ env.IMAGE }}:latest .
          docker push ${{ env.IMAGE }}:${{ steps.tag.outputs.tag }}
          docker push ${{ env.IMAGE }}:latest

      - name: Build summary
        run: |
          echo "### ðŸ“¦ Docker Image" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Image:** \`${{ env.IMAGE }}:${{ steps.tag.outputs.tag }}\`" >> "$GITHUB_STEP_SUMMARY"

  # --------------------------------------------------------------------------
  # Deploy to Cloud Run
  # --------------------------------------------------------------------------
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: [build]

    permissions:
      contents: read
      id-token: write

    environment:
      name: production
      url: ${{ steps.url.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        run: |
          MEMORY="${{ github.event.inputs.memory || '1Gi' }}"
          gcloud run deploy ${{ env.SERVICE }} \
            --image=${{ env.IMAGE }}:${{ needs.build.outputs.image_tag }} \
            --region=${{ env.REGION }} \
            --port=8080 \
            --memory="${MEMORY}" \
            --allow-unauthenticated \
            --set-env-vars="API_KEYS=${{ secrets.API_KEY }},REQUIRE_AUTH=true" \
            --quiet

      - name: Get deployment URL
        id: url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "url=${URL}" >> "$GITHUB_OUTPUT"

      - name: Deployment summary
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "### ðŸš€ Deployed to Cloud Run" >> "$GITHUB_STEP_SUMMARY"
          echo "- **URL:** ${URL}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Image:** \`${{ needs.build.outputs.image_tag }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Region:** ${{ env.REGION }}" >> "$GITHUB_STEP_SUMMARY"

  # --------------------------------------------------------------------------
  # Smoke Test â€” Verify the deployment is healthy
  # --------------------------------------------------------------------------
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: [deploy]

    steps:
      - name: Get service URL
        id: svc
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Health check
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')

          echo "Waiting 15s for service to stabilize..."
          sleep 15

          echo "Checking ${URL}/health ..."
          STATUS=$(curl -s -o /tmp/health_response -w "%{http_code}" "${URL}/health" --max-time 30)
          BODY=$(cat /tmp/health_response)

          echo "### ðŸ¥ Smoke Test" >> "$GITHUB_STEP_SUMMARY"

          if [ "$STATUS" = "200" ]; then
            echo "âœ… Health check passed (HTTP ${STATUS})"
            echo "- **Status:** âœ… Healthy (HTTP ${STATUS})" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Response:** \`${BODY}\`" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âŒ Health check failed (HTTP ${STATUS})"
            echo "Response: ${BODY}"
            echo "- **Status:** âŒ Failed (HTTP ${STATUS})" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Response:** \`${BODY}\`" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi
