# ==============================================================================
# CD â€” Build, Push & Deploy to Cloud Run (Staging â†’ Production)
# Pipeline: CI Check â†’ Build â†’ Deploy Staging â†’ Smoke Test Staging â†’
#           Deploy Production (manual approval) â†’ Smoke Test Prod â†’ Notify
# Rollback: automatic if production smoke test fails.
# Requires secrets: GCP_PROJECT_ID, GCP_SA_KEY, GCS_BUCKET, API_KEY
# ==============================================================================

name: CD

on:
  push:
    branches: [main]

  # Manual deploy / rollback with custom image tag
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (commit SHA or 'latest' to build fresh)"
        required: false
        default: "latest"
      memory:
        description: "Cloud Run memory allocation"
        required: false
        default: "1Gi"
        type: choice
        options:
          - 512Mi
          - 1Gi
          - 2Gi
      skip_staging:
        description: "Skip staging and deploy directly to production"
        required: false
        default: false
        type: boolean

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

env:
  REGION: europe-west1
  SERVICE: ai-product-detector
  SERVICE_STAGING: ai-product-detector-staging
  REGISTRY: europe-west1-docker.pkg.dev
  IMAGE: europe-west1-docker.pkg.dev/ai-product-detector-487013/ai-product-detector/api

jobs:
  # --------------------------------------------------------------------------
  # Wait for CI to pass (on push events)
  # --------------------------------------------------------------------------
  ci-check:
    name: Wait for CI
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    permissions:
      checks: read

    steps:
      - name: Wait for CI workflow
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          running-workflow-name: "Wait for CI"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          check-regexp: "^(Lint|Tests|Type Checking|Security Scan)"
          wait-interval: 15
          allowed-conclusions: success

  # --------------------------------------------------------------------------
  # Build & Push Docker Image
  # --------------------------------------------------------------------------
  build:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [ci-check]
    if: always() && (needs.ci-check.result == 'success' || github.event_name == 'workflow_dispatch')

    permissions:
      contents: read
      id-token: write

    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}
      image_full: ${{ steps.tag.outputs.image_full }}

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      # Fetch model checkpoint from GCS (or DVC fallback)
      - name: Fetch model checkpoint
        run: |
          LOCAL_MODEL="models/checkpoints/best_model.pt"
          GCS_MODEL="gs://${{ secrets.GCS_BUCKET }}/models/best_model.pt"
          mkdir -p models/checkpoints

          # Strategy 1: Direct GCS download (Vertex AI trained models)
          if gsutil ls "${GCS_MODEL}" > /dev/null 2>&1; then
            echo "Found model on GCS. Downloading..."
            gsutil cp "${GCS_MODEL}" "${LOCAL_MODEL}"
            echo "Downloaded from GCS."
          fi

          # Strategy 2: DVC pull (original tracked model)
          if [ ! -f "${LOCAL_MODEL}" ]; then
            echo "No model on GCS. Trying DVC pull..."
            pip install dvc[gs] -q
            dvc pull models/checkpoints/best_model.pt.dvc -f || true
          fi

          # Verify
          if [ -f "${LOCAL_MODEL}" ]; then
            SIZE=$(stat -c%s "${LOCAL_MODEL}")
            echo "Model ready: ${LOCAL_MODEL} (${SIZE} bytes)"
          else
            echo "ERROR: No model checkpoint available!"
            exit 1
          fi

      - name: Determine image tag
        id: tag
        run: |
          if [ "${{ github.event.inputs.image_tag }}" != "" ] && [ "${{ github.event.inputs.image_tag }}" != "latest" ]; then
            TAG="${{ github.event.inputs.image_tag }}"
            echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
            echo "image_full=${{ env.IMAGE }}:${TAG}" >> "$GITHUB_OUTPUT"
            echo "skip_build=true" >> "$GITHUB_OUTPUT"
          else
            TAG="${{ github.sha }}"
            echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
            echo "image_full=${{ env.IMAGE }}:${TAG}" >> "$GITHUB_OUTPUT"
            echo "skip_build=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Docker Buildx
        if: steps.tag.outputs.skip_build == 'false'
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        if: steps.tag.outputs.skip_build == 'false'
        run: |
          docker build -f docker/Dockerfile \
            -t ${{ env.IMAGE }}:${{ steps.tag.outputs.tag }} \
            -t ${{ env.IMAGE }}:latest .
          docker push ${{ env.IMAGE }}:${{ steps.tag.outputs.tag }}
          docker push ${{ env.IMAGE }}:latest

      - name: Build summary
        run: |
          echo "### ðŸ“¦ Docker Image" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Image:** \`${{ env.IMAGE }}:${{ steps.tag.outputs.tag }}\`" >> "$GITHUB_STEP_SUMMARY"

  # --------------------------------------------------------------------------
  # Deploy to Staging
  # --------------------------------------------------------------------------
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build]
    if: ${{ github.event.inputs.skip_staging != 'true' }}

    permissions:
      contents: read
      id-token: write

    environment:
      name: staging
      url: ${{ steps.url.outputs.url }}

    outputs:
      url: ${{ steps.url.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run (Staging)
        run: |
          MEMORY="${{ github.event.inputs.memory || '1Gi' }}"
          gcloud run deploy ${{ env.SERVICE_STAGING }} \
            --image=${{ needs.build.outputs.image_full }} \
            --region=${{ env.REGION }} \
            --port=8080 \
            --memory="${MEMORY}" \
            --allow-unauthenticated \
            --set-env-vars="API_KEYS=${{ secrets.API_KEY }},REQUIRE_AUTH=true,ENVIRONMENT=staging" \
            --tag=staging \
            --no-traffic \
            --quiet \
            2>/dev/null || \
          gcloud run deploy ${{ env.SERVICE_STAGING }} \
            --image=${{ needs.build.outputs.image_full }} \
            --region=${{ env.REGION }} \
            --port=8080 \
            --memory="${MEMORY}" \
            --allow-unauthenticated \
            --set-env-vars="API_KEYS=${{ secrets.API_KEY }},REQUIRE_AUTH=true,ENVIRONMENT=staging" \
            --quiet

      - name: Get staging URL
        id: url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_STAGING }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "url=${URL}" >> "$GITHUB_OUTPUT"
          echo "Staging URL: ${URL}"

      - name: Staging deployment summary
        run: |
          echo "### ðŸ—ï¸ Deployed to Staging" >> "$GITHUB_STEP_SUMMARY"
          echo "- **URL:** ${{ steps.url.outputs.url }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Image:** \`${{ needs.build.outputs.image_tag }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Region:** ${{ env.REGION }}" >> "$GITHUB_STEP_SUMMARY"

  # --------------------------------------------------------------------------
  # Smoke Test Staging
  # --------------------------------------------------------------------------
  smoke-test-staging:
    name: Smoke Test (Staging)
    runs-on: ubuntu-latest
    needs: [deploy-staging]

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Run smoke tests against staging
        run: |
          URL="${{ needs.deploy-staging.outputs.url }}"
          echo "Running smoke tests against staging: ${URL}"

          echo "Waiting 20s for service to stabilize..."
          sleep 20

          FAILED=0

          # Test 1: Health check
          echo "--- Test 1: Health endpoint ---"
          STATUS=$(curl -s -o /tmp/health -w "%{http_code}" "${URL}/health" --max-time 30)
          if [ "$STATUS" = "200" ]; then
            echo "âœ… Health check passed (HTTP ${STATUS})"
          else
            echo "âŒ Health check failed (HTTP ${STATUS})"
            cat /tmp/health
            FAILED=1
          fi

          # Test 2: Root/docs endpoint returns 200
          echo "--- Test 2: API docs endpoint ---"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${URL}/docs" --max-time 30)
          if [ "$STATUS" = "200" ]; then
            echo "âœ… Docs endpoint passed (HTTP ${STATUS})"
          else
            echo "âŒ Docs endpoint failed (HTTP ${STATUS})"
            FAILED=1
          fi

          # Test 3: API responds to predict endpoint (should return 401/422, not 500)
          echo "--- Test 3: Predict endpoint responsiveness ---"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${URL}/predict" --max-time 30)
          if [ "$STATUS" -lt 500 ]; then
            echo "âœ… Predict endpoint responsive (HTTP ${STATUS})"
          else
            echo "âŒ Predict endpoint server error (HTTP ${STATUS})"
            FAILED=1
          fi

          # Summary
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ðŸ§ª Staging Smoke Tests" >> "$GITHUB_STEP_SUMMARY"
          if [ "$FAILED" -eq 0 ]; then
            echo "âœ… All smoke tests passed" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âŒ Some smoke tests failed" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

  # --------------------------------------------------------------------------
  # Deploy to Production (requires manual approval via GitHub Environments)
  # --------------------------------------------------------------------------
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, smoke-test-staging]
    if: always() && (needs.smoke-test-staging.result == 'success' || github.event.inputs.skip_staging == 'true')

    permissions:
      contents: read
      id-token: write

    environment:
      name: production
      url: ${{ steps.url.outputs.url }}

    outputs:
      url: ${{ steps.url.outputs.url }}
      previous_revision: ${{ steps.pre-deploy.outputs.previous_revision }}

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Capture current revision for rollback
      - name: Capture current production revision
        id: pre-deploy
        run: |
          PREV=$(gcloud run services describe ${{ env.SERVICE }} \
            --region=${{ env.REGION }} \
            --format='value(status.latestReadyRevisionName)' 2>/dev/null || echo "none")
          echo "previous_revision=${PREV}" >> "$GITHUB_OUTPUT"
          echo "Current production revision: ${PREV}"

      - name: Deploy to Cloud Run (Production)
        run: |
          MEMORY="${{ github.event.inputs.memory || '1Gi' }}"
          gcloud run deploy ${{ env.SERVICE }} \
            --image=${{ needs.build.outputs.image_full }} \
            --region=${{ env.REGION }} \
            --port=8080 \
            --memory="${MEMORY}" \
            --allow-unauthenticated \
            --set-env-vars="API_KEYS=${{ secrets.API_KEY }},REQUIRE_AUTH=true,ENVIRONMENT=production" \
            --quiet

      - name: Get production URL
        id: url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "url=${URL}" >> "$GITHUB_OUTPUT"

      - name: Production deployment summary
        run: |
          echo "### ðŸš€ Deployed to Production" >> "$GITHUB_STEP_SUMMARY"
          echo "- **URL:** ${{ steps.url.outputs.url }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Image:** \`${{ needs.build.outputs.image_tag }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Region:** ${{ env.REGION }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Previous revision:** \`${{ steps.pre-deploy.outputs.previous_revision }}\`" >> "$GITHUB_STEP_SUMMARY"

  # --------------------------------------------------------------------------
  # Smoke Test Production (with automatic rollback on failure)
  # --------------------------------------------------------------------------
  smoke-test-production:
    name: Smoke Test (Production)
    runs-on: ubuntu-latest
    needs: [deploy-production]

    outputs:
      status: ${{ steps.smoke.outputs.status }}

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Run production smoke tests
        id: smoke
        run: |
          URL="${{ needs.deploy-production.outputs.url }}"
          echo "Running smoke tests against production: ${URL}"

          echo "Waiting 15s for service to stabilize..."
          sleep 15

          FAILED=0

          # Test 1: Health check
          echo "--- Test 1: Health endpoint ---"
          STATUS=$(curl -s -o /tmp/health -w "%{http_code}" "${URL}/health" --max-time 30)
          BODY=$(cat /tmp/health)
          if [ "$STATUS" = "200" ]; then
            echo "âœ… Health check passed (HTTP ${STATUS})"
          else
            echo "âŒ Health check failed (HTTP ${STATUS}): ${BODY}"
            FAILED=1
          fi

          # Test 2: Docs endpoint
          echo "--- Test 2: Docs endpoint ---"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${URL}/docs" --max-time 30)
          if [ "$STATUS" = "200" ]; then
            echo "âœ… Docs endpoint passed (HTTP ${STATUS})"
          else
            echo "âŒ Docs endpoint failed (HTTP ${STATUS})"
            FAILED=1
          fi

          # Test 3: API responsiveness
          echo "--- Test 3: Predict endpoint responsiveness ---"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${URL}/predict" --max-time 30)
          if [ "$STATUS" -lt 500 ]; then
            echo "âœ… Predict endpoint responsive (HTTP ${STATUS})"
          else
            echo "âŒ Predict endpoint server error (HTTP ${STATUS})"
            FAILED=1
          fi

          # Summary
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ðŸ¥ Production Smoke Tests" >> "$GITHUB_STEP_SUMMARY"
          if [ "$FAILED" -eq 0 ]; then
            echo "status=success" >> "$GITHUB_OUTPUT"
            echo "âœ… All production smoke tests passed" >> "$GITHUB_STEP_SUMMARY"
            echo "- **URL:** ${URL}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "status=failure" >> "$GITHUB_OUTPUT"
            echo "âŒ Production smoke tests failed â€” triggering rollback" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

  # --------------------------------------------------------------------------
  # Automatic Rollback (if production smoke test fails)
  # --------------------------------------------------------------------------
  rollback:
    name: Rollback Production
    runs-on: ubuntu-latest
    needs: [deploy-production, smoke-test-production]
    if: failure() && needs.smoke-test-production.result == 'failure'

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Rollback to previous revision
        run: |
          PREV_REVISION="${{ needs.deploy-production.outputs.previous_revision }}"

          if [ "${PREV_REVISION}" = "none" ] || [ -z "${PREV_REVISION}" ]; then
            echo "âš ï¸ No previous revision to rollback to"
            echo "### âš ï¸ Rollback Skipped" >> "$GITHUB_STEP_SUMMARY"
            echo "No previous revision available for rollback." >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

          echo "Rolling back to revision: ${PREV_REVISION}"
          gcloud run services update-traffic ${{ env.SERVICE }} \
            --region=${{ env.REGION }} \
            --to-revisions="${PREV_REVISION}=100" \
            --quiet

          echo "### ðŸ”„ Rollback Executed" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Rolled back to:** \`${PREV_REVISION}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Reason:** Production smoke test failed" >> "$GITHUB_STEP_SUMMARY"

      - name: Verify rollback
        run: |
          sleep 10
          URL=$(gcloud run services describe ${{ env.SERVICE }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${URL}/health" --max-time 30)
          if [ "$STATUS" = "200" ]; then
            echo "âœ… Rollback verified â€” service is healthy"
            echo "- **Post-rollback health:** âœ… Healthy" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âŒ Service still unhealthy after rollback (HTTP ${STATUS})"
            echo "- **Post-rollback health:** âŒ Still unhealthy (HTTP ${STATUS})" >> "$GITHUB_STEP_SUMMARY"
          fi

  # --------------------------------------------------------------------------
  # Notify â€” Post deployment result
  # --------------------------------------------------------------------------
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [build, deploy-production, smoke-test-production]
    if: always()

    steps:
      - name: Deployment result summary
        run: |
          echo "### ðŸ“‹ Deployment Pipeline Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Stage | Result |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Build | ${{ needs.build.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Deploy Production | ${{ needs.deploy-production.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Smoke Test Prod | ${{ needs.smoke-test-production.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ needs.smoke-test-production.result }}" = "success" ]; then
            echo "> âœ… **Deployment successful!**" >> "$GITHUB_STEP_SUMMARY"
            echo "> URL: ${{ needs.deploy-production.outputs.url }}" >> "$GITHUB_STEP_SUMMARY"
          elif [ "${{ needs.smoke-test-production.result }}" = "failure" ]; then
            echo "> âŒ **Deployment failed â€” automatic rollback triggered**" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "> âš ï¸ **Deployment status: ${{ needs.smoke-test-production.result }}**" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Commit:** \`${{ github.sha }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "**Triggered by:** ${{ github.actor }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Image tag:** \`${{ needs.build.outputs.image_tag }}\`" >> "$GITHUB_STEP_SUMMARY"
