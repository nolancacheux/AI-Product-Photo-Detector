# ==============================================================================
# CI — Lint, Type Check, Tests, Security (informational)
# Runs on every push and PR to main.
# ==============================================================================

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

jobs:
  # --------------------------------------------------------------------------
  # Lint, Type Check & Tests — single job, fast feedback
  # --------------------------------------------------------------------------
  ci:
    name: Lint, Type Check & Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-ci-${{ runner.os }}-py3.11-${{ hashFiles('pyproject.toml') }}
          restore-keys: pip-ci-${{ runner.os }}-py3.11-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Lint & format
        run: |
          ruff check src/ tests/
          ruff format --check src/ tests/

      - name: Type check
        run: mypy src/ --ignore-missing-imports

      - name: Run tests with coverage
        env:
          RATE_LIMIT_ENABLED: "false"
        run: |
          pytest tests/ -v --tb=short \
            --cov=src \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --junitxml=test-results.xml

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            coverage.xml
            test-results.xml
          retention-days: 14

      - name: Coverage summary
        if: always()
        run: |
          COVERAGE=$(python -m coverage report --format=total 2>/dev/null || echo "0")
          if [ "${COVERAGE}" -ge 80 ]; then COLOR="brightgreen"
          elif [ "${COVERAGE}" -ge 60 ]; then COLOR="yellow"
          else COLOR="orange"; fi
          echo "### Test Results" >> "$GITHUB_STEP_SUMMARY"
          echo "![Coverage](https://img.shields.io/badge/coverage-${COVERAGE}%25-${COLOR})" >> "$GITHUB_STEP_SUMMARY"
          python -m coverage report --format=markdown >> "$GITHUB_STEP_SUMMARY" 2>/dev/null || true

  # --------------------------------------------------------------------------
  # Security — informational, never blocks CI
  # --------------------------------------------------------------------------
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install and audit
        run: |
          python -m pip install --upgrade pip
          pip install -e "."
          pip install pip-audit bandit

      - name: pip-audit
        run: |
          pip freeze --exclude-editable > /tmp/requirements-audit.txt
          pip-audit --desc -r /tmp/requirements-audit.txt || true

      - name: bandit
        run: bandit -r src/ -s B101,B601,B104,B614,B404,B607,B603,B108 -f screen || true

  # --------------------------------------------------------------------------
  # CodeQL — GitHub Advanced Security (free, runs in background)
  # --------------------------------------------------------------------------
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest

    permissions:
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
          queries: security-and-quality

      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"
