# ==============================================================================
# CI â€” Lint, Type Check, Tests, Security Scanning
# Runs on every push and PR to main.
# Matrix: Python 3.11 & 3.12
# Includes: CodeQL SAST, Trivy container scan, pip-audit, bandit
# ==============================================================================

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

jobs:
  # --------------------------------------------------------------------------
  # Lint & Format
  # --------------------------------------------------------------------------
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-lint-${{ runner.os }}-py3.11-${{ hashFiles('pyproject.toml', 'setup.cfg', 'requirements*.txt') }}
          restore-keys: |
            pip-lint-${{ runner.os }}-py3.11-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run ruff linting
        run: ruff check src/ tests/

      - name: Run ruff format check
        run: ruff format --check src/ tests/

  # --------------------------------------------------------------------------
  # Type Checking
  # --------------------------------------------------------------------------
  type-check:
    name: Type Checking (mypy)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-typecheck-${{ runner.os }}-py3.11-${{ hashFiles('pyproject.toml', 'setup.cfg', 'requirements*.txt') }}
          restore-keys: |
            pip-typecheck-${{ runner.os }}-py3.11-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run mypy
        run: mypy src/ --ignore-missing-imports

  # --------------------------------------------------------------------------
  # Tests (matrix: Python 3.11, 3.12)
  # --------------------------------------------------------------------------
  test:
    name: Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]

    outputs:
      coverage-pct: ${{ steps.coverage-badge.outputs.coverage }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-test-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('pyproject.toml', 'setup.cfg', 'requirements*.txt') }}
          restore-keys: |
            pip-test-${{ runner.os }}-py${{ matrix.python-version }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests with coverage
        env:
          RATE_LIMIT_ENABLED: "false"
        run: |
          pytest tests/ -v --tb=short \
            --cov=src \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --cov-report=html:htmlcov/ \
            --junitxml=test-results.xml

      - name: Upload coverage report
        if: matrix.python-version == '3.11' && always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov/
            test-results.xml
          retention-days: 14

      - name: Extract coverage percentage
        if: matrix.python-version == '3.11' && always()
        id: coverage-badge
        run: |
          COVERAGE=$(python -m coverage report --format=total 2>/dev/null || echo "0")
          echo "coverage=${COVERAGE}" >> "$GITHUB_OUTPUT"
          echo "Coverage: ${COVERAGE}%"

      - name: Coverage summary with badge
        if: matrix.python-version == '3.11' && always()
        run: |
          COVERAGE=$(python -m coverage report --format=total 2>/dev/null || echo "0")

          # Determine badge color
          if [ "${COVERAGE}" -ge 80 ]; then
            COLOR="brightgreen"
          elif [ "${COVERAGE}" -ge 60 ]; then
            COLOR="yellow"
          elif [ "${COVERAGE}" -ge 40 ]; then
            COLOR="orange"
          else
            COLOR="red"
          fi

          echo "### ðŸ“Š Coverage Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "![Coverage](https://img.shields.io/badge/coverage-${COVERAGE}%25-${COLOR})" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          python -m coverage report --format=markdown >> "$GITHUB_STEP_SUMMARY" 2>/dev/null || \
            echo "Coverage details unavailable" >> "$GITHUB_STEP_SUMMARY"

  # --------------------------------------------------------------------------
  # Security Scan â€” Dependency Audit + Static Analysis
  # --------------------------------------------------------------------------
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-security-${{ runner.os }}-py3.11-${{ hashFiles('pyproject.toml', 'setup.cfg', 'requirements*.txt') }}
          restore-keys: |
            pip-security-${{ runner.os }}-py3.11-

      - name: Install project and audit tools
        run: |
          python -m pip install --upgrade pip
          pip install -e "."
          pip install pip-audit bandit safety

      - name: Run pip-audit (dependency vulnerabilities)
        run: pip-audit --strict --desc

      - name: Run bandit (code security analysis)
        run: |
          bandit -r src/ -s B101,B601 -f json -o bandit-report.json || true
          bandit -r src/ -s B101,B601 -f screen

      - name: Upload bandit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json
          retention-days: 14

      - name: Security scan summary
        if: always()
        run: |
          echo "### ðŸ”’ Security Scan Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Check | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|" >> "$GITHUB_STEP_SUMMARY"

          # pip-audit result
          if pip-audit --strict --desc > /dev/null 2>&1; then
            echo "| pip-audit (deps) | âœ… No vulnerabilities |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| pip-audit (deps) | âš ï¸ Vulnerabilities found |" >> "$GITHUB_STEP_SUMMARY"
          fi

          # bandit result
          if bandit -r src/ -s B101,B601 -q 2>/dev/null; then
            echo "| bandit (SAST) | âœ… No issues |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| bandit (SAST) | âš ï¸ Issues found |" >> "$GITHUB_STEP_SUMMARY"
          fi

  # --------------------------------------------------------------------------
  # CodeQL â€” GitHub Advanced Security SAST
  # --------------------------------------------------------------------------
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest

    permissions:
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
          queries: security-and-quality

      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

  # --------------------------------------------------------------------------
  # Trivy â€” Container Image Vulnerability Scan
  # --------------------------------------------------------------------------
  trivy-scan:
    name: Trivy Container Scan
    runs-on: ubuntu-latest
    needs: [lint, test]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          push: false
          load: true
          tags: ai-product-detector:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: "ai-product-detector:scan"
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
          output: "trivy-results.txt"

      - name: Upload Trivy scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results
          path: trivy-results.txt
          retention-days: 14

      - name: Run Trivy (SARIF for GitHub Security tab)
        if: always()
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: "ai-product-detector:scan"
          format: "sarif"
          output: "trivy-results.sarif"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy results to GitHub Security tab
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"
          category: "trivy"

      - name: Trivy scan summary
        if: always()
        run: |
          echo "### ðŸ³ Container Security (Trivy)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ -f trivy-results.txt ]; then
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            head -100 trivy-results.txt >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âœ… No CRITICAL/HIGH vulnerabilities found" >> "$GITHUB_STEP_SUMMARY"
          fi

  # --------------------------------------------------------------------------
  # Docker Build Validation (PR only)
  # --------------------------------------------------------------------------
  docker-build:
    name: Docker Build Validation
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          push: false
          tags: ai-product-detector:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
